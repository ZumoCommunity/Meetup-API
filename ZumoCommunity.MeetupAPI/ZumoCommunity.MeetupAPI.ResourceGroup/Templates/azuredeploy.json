{
	"$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
	"contentVersion": "1.0.0.0",
	"parameters": {
		"SqlServer-AdminLogin": {
			"type": "string",
			"minLength": 1
		},
		"SqlServer-AdminPassword": {
			"type": "securestring",
			"minLength": 8
		}
	},
	"variables": {
		"UniqueId": "[uniqueString(resourceGroup().id)]",

		"WebFarm-Name": "[concat('meetup-webfarm-', variables('UniqueId'))]",
		"WebFarm-SKU": "Standard",
		"WebFarm-WorkerSize": "1",
		"WebFarm-WorkersCount": 1,

		"WebApp-API-OData-Name": "[concat('meetup-api-odata-', variables('UniqueId'))]",

		"SqlServer-Name": "[concat('meetup-sql-server-', variables('UniqueId'))]",

		"MeetupDatabase-Name": "meetup-db",
		"MeetupDatabase-Edition": "Basic",
		"MeetupDatabase-PricingPlan": "Basic",
		"MeetupDatabase-Collation": "SQL_Latin1_General_CP1_CI_AS",

		"MeetupApi-ODataName": "[concat('meetup-api-odata-', variables('UniqueId'))]",

		"ServiceBus-NamespaceName": "[concat('meetup-servicebus-', variables('UniqueId'))]",
		"ServiceBus-SKU": "Standard",
		"ServiceBus-TopicName": "Events",
		"ServiceBus-SubscriptionName": "Internal"
	},
	"resources": [
		{
			"name": "[variables('WebFarm-Name')]",
			"type": "Microsoft.Web/serverfarms",
			"location": "[resourceGroup().location]",
			"apiVersion": "2014-06-01",
			"tags": {
				"displayName": "WebFarm"
			},
			"properties": {
				"name": "[variables('WebFarm-Name')]",
				"sku": "[variables('WebFarm-SKU')]",
				"workerSize": "[variables('WebFarm-WorkerSize')]",
				"numberOfWorkers": "[variables('WebFarm-WorkersCount')]"
			}
		},
		{
			"name": "[variables('SqlServer-Name')]",
			"type": "Microsoft.Sql/servers",
			"location": "[resourceGroup().location]",
			"apiVersion": "2014-04-01-preview",
			"dependsOn": [],
			"tags": {
				"displayName": "SqlServer"
			},
			"properties": {
				"administratorLogin": "[parameters('SqlServer-AdminLogin')]",
				"administratorLoginPassword": "[parameters('SqlServer-AdminPassword')]"
			},
			"resources": [
				{
					"name": "AllowAllWindowsAzureIps",
					"type": "firewallrules",
					"location": "[resourceGroup().location]",
					"apiVersion": "2014-04-01-preview",
					"dependsOn": [
						"[resourceId('Microsoft.Sql/servers', variables('SqlServer-Name'))]"
					],
					"properties": {
						"startIpAddress": "0.0.0.0",
						"endIpAddress": "0.0.0.0"
					}
				},
				{
					"name": "[variables('MeetupDatabase-Name')]",
					"type": "databases",
					"location": "[resourceGroup().location]",
					"apiVersion": "2014-04-01-preview",
					"dependsOn": [
						"[resourceId('Microsoft.Sql/servers', variables('SqlServer-Name'))]"
					],
					"tags": {
						"displayName": "MeetupDatabase"
					},
					"properties": {
						"collation": "[variables('MeetupDatabase-Collation')]",
						"edition": "[variables('MeetupDatabase-Edition')]",
						"maxSizeBytes": "1073741824",
						"requestedServiceObjectiveName": "[variables('MeetupDatabase-PricingPlan')]"
					}
				}
			]
		},
		{
			"apiVersion": "2015-08-01",
			"name": "[variables('ServiceBus-NamespaceName')]",
			"type": "Microsoft.ServiceBus/namespaces",
			"location": "[resourceGroup().location]",
			"kind": "Messaging",
			"sku": {
				"name": "[variables('ServiceBus-SKU')]",
				"tier": "[variables('ServiceBus-SKU')]"
			},
			"tags": {
				"displayName": "ServiceBus"
			},
			"resources": [
				{
					"apiVersion": "2015-08-01",
					"name": "[variables('ServiceBus-TopicName')]",
					"type": "topics",
					"dependsOn": [
						"[concat('Microsoft.ServiceBus/namespaces/', variables('ServiceBus-NamespaceName'))]"
					],
					"tags": {
						"displayName": "EventsTopic"
					},
					"properties": {
						"path": "[variables('ServiceBus-TopicName')]"
					},
					"resources": [
						{
							"apiVersion": "2015-08-01",
							"name": "[variables('ServiceBus-SubscriptionName')]",
							"type": "subscriptions",
							"dependsOn": [
								"[variables('ServiceBus-TopicName')]"
							],
							"tags": {
								"displayName": "InternalSubscription"
							},
							"properties": {
							}
						}
					]
				}
			]
		},
		{
			"name": "[variables('MeetupApi-ODataName')]",
			"type": "Microsoft.Web/sites",
			"location": "[resourceGroup().location]",
			"apiVersion": "2015-08-01",
			"dependsOn": [
				"[resourceId('Microsoft.Web/serverfarms', variables('WebFarm-Name'))]"
			],
			"tags": {
				"[concat('hidden-related:', resourceId('Microsoft.Web/serverfarms', variables('WebFarm-Name')))]": "Resource",
				"displayName": "MeetupApi-OData"
			},
			"properties": {
				"name": "[variables('MeetupApi-ODataName')]",
				"serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('WebFarm-Name'))]"
			},
			"resources": [
				{
					"name": "connectionstrings",
					"type": "config",
					"apiVersion": "2015-08-01",
					"dependsOn": [
						"[resourceId('Microsoft.Web/sites', variables('MeetupApi-ODataName'))]",
						"[resourceId('Microsoft.Sql/servers', variables('SqlServer-Name'))]",
						"[resourceId('Microsoft.ServiceBus/namespaces', variables('ServiceBus-NamespaceName'))]"
					],
					"tags": {
						"displayName": "ConnectionStrings"
					},
					"properties": {
						"Database": {
							"type": "SQLAzure",
							"value": "[concat('Data Source=tcp:', reference(concat('Microsoft.Sql/servers/', variables('SqlServer-Name'))).fullyQualifiedDomainName, ',1433;Initial Catalog=', variables('MeetupDatabase-Name'), ';User Id=', parameters('SqlServer-AdminLogin'), '@', reference(concat('Microsoft.Sql/servers/', variables('SqlServer-Name'))).fullyQualifiedDomainName, ';Password=', parameters('SqlServer-AdminPassword'), ';')]"
						},
						"ServicBus": {
							"type": "Custom",
							"value": "[listkeys(resourceId('Microsoft.ServiceBus/namespaces/authorizationRules', variables('ServiceBus-NamespaceName'), 'RootManageSharedAccessKey'), '2015-08-01').primaryConnectionString]"
						}
					}
				},
				{
					"name": "appsettings",
					"type": "config",
					"apiVersion": "2015-08-01",
						"dependsOn": [
							"[resourceId('Microsoft.Web/sites', variables('MeetupApi-ODataName'))]"
						],
					"tags": {
						"displayName": "ApplicationSettings"
					},
					"properties": {
					}
				}
			]
		}
	],
	"outputs": {
	}
}
